name: 构建Passwall2 (修复版)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180  # 增加超时时间

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 安装依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential ccache cmake git make libssl-dev \
          libncurses5-dev zlib1g-dev gawk gettext flex bison \
          python3 python3-pip rsync unzip wget pkg-config libtool autoconf automake \
          libreadline-dev curl file upx-ucl
        # 安装Passwall2可能需要的额外依赖
        sudo apt-get install -y libjson-c-dev libuv1-dev liblua5.1-0-dev

    - name: 克隆OpenWrt源码
      run: |
        # 使用更稳定的源
        git clone https://github.com/immortalwrt/immortalwrt.git openwrt
        cd openwrt
        # 切换到稳定分支
        git checkout openwrt-21.02
        
        # 更新feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 配置编译环境
      run: |
        cd openwrt
        # 创建基本配置
        cat > .config << 'EOF'
CONFIG_TARGET_ramips=y
CONFIG_TARGET_ramips_mt7621=y
CONFIG_TARGET_ramips_mt7621_DEVICE_hiwifi_hc5962=y
CONFIG_PACKAGE_luci-app-passwall2=y
CONFIG_PACKAGE_luci-i18n-passwall2-zh-cn=y
EOF
        make defconfig

    - name: 修复libdeflate问题
      run: |
        cd openwrt
        # 先尝试编译libdeflate
        if ! make tools/libdeflate/compile V=s -j1; then
          echo "libdeflate编译失败，使用备用方案"
          mkdir -p staging_dir/host/bin
          cat > staging_dir/host/bin/libdeflate-gzip << 'EOF'
#!/bin/bash
exec gzip "$@"
EOF
          chmod +x staging_dir/host/bin/libdeflate-gzip
        fi

    - name: 确保Lua源码完整
      run: |
        cd openwrt
        # 清理可能损坏的文件
        rm -f dl/lua-*.tar.gz
        # 重新下载
        make package/utils/lua/clean
        make package/utils/lua/download V=s
        # 验证文件完整性
        if [ -f dl/lua-5.1.5.tar.gz ]; then
          gzip -t dl/lua-5.1.5.tar.gz || exit 1
        fi

    - name: 分步编译基础组件
      run: |
        cd openwrt
        echo "=== 第一步：编译工具链 ==="
        make tools/compile -j2 || make tools/compile -j1
        
        echo "=== 第二步：编译工具 ==="  
        make toolchain/compile -j2 || make toolchain/compile -j1
        
        echo "=== 第三步：编译Lua ==="
        make package/utils/lua/compile -j1

    - name: 编译Passwall2及其依赖
      run: |
        cd openwrt
        set -e  # 遇到错误立即停止
        
        echo "=== 编译Passwall2依赖包 ==="
        # 先编译Passwall2需要的核心依赖
        for pkg in luci-base luci-compat iptables-mod-tproxy; do
          echo "编译依赖包: $pkg"
          make package/feeds/packages/$pkg/compile -j1 || true
        done
        
        echo "=== 开始编译Passwall2 ==="
        # 保存编译日志
        make package/feeds/packages/luci-app-passwall2/clean
        make package/feeds/packages/luci-app-passwall2/compile V=s -j1 2>&1 | tee passwall2_compile.log
        
        # 检查是否成功
        if [ ${PIPESTATUS[0]} -ne 0 ]; then
          echo "❌ Passwall2编译失败！"
          echo "=== 错误摘要 ==="
          grep -i "error\|failed" passwall2_compile.log | head -20
          exit 1
        fi

    - name: 检查生成的文件
      run: |
        cd openwrt
        echo "=== 查找生成的IPK文件 ==="
        find bin -name "*.ipk" | grep -i passwall || echo "未找到Passwall2的IPK文件"
        
        echo "=== 所有IPK文件列表 ==="
        find bin -name "*.ipk" | head -20

    - name: 上传编译成果
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: Passwall2_编译成果
        path: |
          openwrt/bin/packages/*/*/*passwall*
          openwrt/bin/targets/*/*/packages/*passwall*
        retention-days: 7

    - name: 上传错误日志
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: 编译错误日志
        path: |
          openwrt/passwall2_compile.log
          openwrt/logs/
        retention-days: 5
