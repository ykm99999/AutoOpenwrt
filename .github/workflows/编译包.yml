name: 司洛SL-3000 ImmortalWrt 编译 - 修复工具链

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x
  REPO_BRANCH: main
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 200

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: 安装完整依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ccache \
          cmake \
          git \
          make \
          libssl-dev \
          libncurses5-dev \
          zlib1g-dev \
          gawk \
          gettext \
          flex \
          bison \
          python3 \
          python3-pip \
          rsync \
          unzip \
          wget \
          curl \
          file \
          gzip \
          bzip2 \
          xz-utils \
          pkg-config \
          libtool \
          automake \
          autoconf \
          gettext \
          libelf-dev \
          libfuse-dev \
          libgmp3-dev \
          libmpc-dev \
          libmpfr-dev \
          libltdl-dev \
          meson \
          ninja-build

    - name: 清理空间
      run: |
        sudo apt-get autoremove -y
        sudo apt-get clean
        sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android 2>/dev/null || true

    - name: 配置缓存
      uses: actions/cache@v3
      with:
        path: |
          ~/.ccache
          ./openwrt/dl
          ./openwrt/staging_dir
          ./openwrt/build_dir
        key: ${{ runner.os }}-sl3000-full-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-sl3000-full-

    - name: 克隆源码
      run: |
        if [ -d "openwrt" ] && [ -d "openwrt/.git" ]; then
          cd openwrt
          git fetch --depth=1 origin main
          git reset --hard origin/main
        else
          rm -rf openwrt
          git clone --depth=1 --branch $REPO_BRANCH $REPO_URL openwrt
        fi

    - name: 修复 libdeflate 问题
      run: |
        cd openwrt
        
        echo "=== 修复 libdeflate 工具链问题 ==="
        
        # 手动修复 libdeflate 问题
        if [ ! -f "dl/libdeflate-1.18.tar.gz" ]; then
          wget -P dl/ https://github.com/ebiggers/libdeflate/archive/refs/tags/v1.18.tar.gz -O dl/libdeflate-1.18.tar.gz
        fi
        
        # 确保 feeds 配置正确
        cat > feeds.conf.default << 'EOF'
src-git packages https://git.openwrt.org/feed/packages.git
src-git luci https://git.openwrt.org/project/luci.git
src-git routing https://git.openwrt.org/feed/routing.git
EOF

        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 创建极简配置
      run: |
        cd openwrt
        
        echo "=== 创建极简配置 ==="
        
        cat > .config << 'EOF'
CONFIG_TARGET_mediatek=y
CONFIG_TARGET_mediatek_mt7981=y
CONFIG_TARGET_mediatek_mt7981_DEVICE_cmcc_rax3000m-nand-ubootmod=y
CONFIG_TARGET_ROOTFS_PARTSIZE=256

# 基础包 - 避免复杂依赖
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-base=y
CONFIG_PACKAGE_luci-compat=y
CONFIG_PACKAGE_luci-theme-bootstrap=y
CONFIG_PACKAGE_luci-i18n-base-zh-cn=y

# 网络基础
CONFIG_PACKAGE_wpad-basic-wolfssl=y
CONFIG_PACKAGE_kmod-mt7981-firmware=y

# 基础工具
CONFIG_PACKAGE_block-mount=y
CONFIG_PACKAGE_fdisk=y

# 跳过有问题的包
# CONFIG_PACKAGE_lua is not set
# CONFIG_PACKAGE_luci-app-passwall2 is not set
# CONFIG_PACKAGE_docker is not set
EOF
        
        make defconfig

    - name: 手动编译工具链
      run: |
        cd openwrt
        
        echo "=== 手动编译工具链 ==="
        
        # 先编译 host 工具
        echo "编译 host 工具..."
        make tools/compile -j1 V=s
        
        # 编译 toolchain
        echo "编译 toolchain..."
        make toolchain/compile -j1 V=s
        
        # 检查工具是否就位
        echo "检查编译工具:"
        ls -la staging_dir/host/bin/ | grep gzip || true

    - name: 下载所有包
      run: |
        cd openwrt
        make download -j2

    - name: 分步编译
      run: |
        cd openwrt
        
        echo "=== 分步编译固件 ==="
        
        # 逐步编译，确保每一步都成功
        echo "1. 编译目标工具..."
        make target/compile -j2 || make target/compile -j1 V=s
        
        echo "2. 编译内核..."
        make target/linux/compile -j2 || make target/linux/compile -j1 V=s
        
        echo "3. 编译基础包..."
        make package/compile -j2 || make package/compile -j1 V=s
        
        echo "4. 最终编译..."
        make -j2 || make -j1 V=s

    - name: 上传固件
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: SL3000-固件
        path: openwrt/bin/targets/**/*
        retention-days: 30

    - name: 发布 Release
      if: success()
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: openwrt/bin/targets/**/*
        tag_name: sl3000-$(date +%Y%m%d-%H%M)
        name: SL3000 固件 $(date +%Y-%m-%d)
        draft: false
