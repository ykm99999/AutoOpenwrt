name: Build Passwall2 (Fixed Lua Host and Routing Feed)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 150

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install deps
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential ccache cmake git make libssl-dev \
          libncurses5-dev zlib1g-dev gawk gettext flex bison \
          python3 python3-pip rsync unzip wget pkg-config libtool autoconf automake \
          libreadline-dev curl file
        sudo apt-get install -y libjson-c-dev libuv1-dev

    - name: Clone and init feeds (with routing fix)
      run: |
        # 添加重试机制
        for i in {1..3}; do
          git clone https://github.com/padavanonly/immortalwrt-mt798x.git openwrt && break || sleep 10
        done
        
        cd openwrt
        
        # 尝试切换到稳定分支
        git checkout main 2>/dev/null || git checkout master 2>/dev/null || echo "Using default branch"
        
        # 修复feeds配置 - 先检查并修复潜在的feeds问题
        if [ -f feeds.conf.default ]; then
          cp feeds.conf.default feeds.conf
        fi
        
        # 分步更新feeds，先更新基础feeds
        ./scripts/feeds update base packages luci routing 2>/dev/null || true
        
        # 如果routing feed失败，尝试从其他源添加
        if [ ! -d "feeds/routing" ]; then
          echo "Routing feed missing, attempting to add manually"
          if grep -q "routing" feeds.conf; then
            echo "Routing feed exists in config but failed to update"
          else
            echo "Adding routing feed manually"
            echo "src-git routing https://git.openwrt.org/feed/routing.git" >> feeds.conf
          fi
        fi
        
        # 完整更新所有feeds
        for i in {1..3}; do
          ./scripts/feeds update -a && break || sleep 10
        done
        
        # 安装feeds前确保目录存在
        mkdir -p feeds/routing 2>/dev/null || true
        
        # 分步安装feeds
        ./scripts/feeds install -a -p base
        ./scripts/feeds install -a -p packages
        ./scripts/feeds install -a -p luci
        ./scripts/feeds install -a -p routing 2>/dev/null || echo "Routing feed installation failed but continuing"
        
        # 验证feeds结构
        echo "=== Feeds structure ==="
        find feeds -maxdepth 2 -type d | head -20

    - name: Fix feeds routing directory
      run: |
        cd openwrt
        
        # 确保feeds/routing目录存在
        if [ ! -d "feeds/routing" ]; then
          echo "Creating missing feeds/routing directory"
          mkdir -p feeds/routing
          
          # 创建基本的index文件
          cat > feeds/routing.index << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<feeds>
  <feed>
    <name>routing</name>
    <path>routing</path>
    <url>https://git.openwrt.org/feed/routing.git</url>
    <branch>master</branch>
  </feed>
</feeds>
EOF
          
          # 创建基本的Makefile
          cat > feeds/routing/Makefile << 'EOF'
# This is a stub Makefile for missing routing feed
include $(TOPDIR)/rules.mk

echo "Routing feed placeholder"

endef

$(eval $(call Build/DefaultTargets))
EOF
        fi

    - name: Run defconfig with error handling
      run: |
        cd openwrt
        
        # 准备.config文件
        if [ -f .config ]; then
          cp .config .config.backup
        fi
        
        # 使用更宽松的方式运行defconfig
        set +e  # 暂时关闭错误退出
        
        # 第一次尝试
        make defconfig 2>&1 | tee defconfig.log
        DEFCONFIG_STATUS=$?
        
        if [ $DEFCONFIG_STATUS -ne 0 ]; then
          echo "First defconfig attempt failed, checking issues..."
          
          # 检查是否是routing相关错误
          if grep -q "feeds/routing" defconfig.log; then
            echo "Routing feed issue detected, applying workaround"
            
            # 备份原始feeds.conf
            cp feeds.conf feeds.conf.original
            
            # 临时注释掉routing feed
            sed -i 's/^src-git routing/# src-git routing/' feeds.conf
            
            # 重新运行defconfig
            make defconfig || echo "Defconfig with routing disabled completed with warnings"
          else
            echo "Unknown defconfig error, attempting to continue"
            # 使用最小配置
            cp .config.backup .config 2>/dev/null || true
          fi
        fi
        
        set -e  # 重新开启错误退出
        
        echo "Defconfig phase completed"

    - name: Setup build environment
      run: |
        cd openwrt
        # 设置基本配置
        echo "CONFIG_CCACHE=y" >> .config
        echo "BUILD_SUFFIX=github" >> .config
        
        # 确保配置一致
        make defconfig

    - name: Build libdeflate with robust fallback
      run: |
        cd openwrt
        if ! make tools/libdeflate/{clean,compile,install} V=s -j2; then
          echo "libdeflate build failed, using system gzip fallback"
          mkdir -p staging_dir/host/bin
          cat > staging_dir/host/bin/libdeflate-gzip <<'EOF'
#!/usr/bin/env bash
if command -v gzip >/dev/null 2>&1; then
  exec gzip "$@"
else
  echo "Error: gzip not found in system" >&2
  exit 1
fi
EOF
          chmod +x staging_dir/host/bin/libdeflate-gzip
        fi
        test -x staging_dir/host/bin/libdeflate-gzip || exit 1
        echo "libdeflate-gzip setup completed"

    - name: Ensure Lua source integrity
      run: |
        cd openwrt
        rm -rf dl/lua-*.tar.gz build_dir/target-*/lua-* build_dir/host/lua-*
        
        make package/utils/lua/clean V=s
        if ! make package/utils/lua/download V=s; then
          echo "Lua download failed, manual download attempt"
          wget -O dl/lua-5.1.5.tar.gz http://www.lua.org/ftp/lua-5.1.5.tar.gz || \
          wget -O dl/lua-5.1.5.tar.gz https://github.com/lua/lua/archive/refs/tags/v5.1.5.tar.gz
        fi
        
        find dl -name "lua-*.tar.gz" -exec gzip -t {} \; || exit 1
        find dl -name "lua-*.tar.gz" -size -10k -delete

    - name: Step-by-step compilation
      run: |
        cd openwrt
        set -e
        
        echo "=== Step 1: Compile tools ==="
        make tools/compile V=s -j2 || make tools/compile V=s -j1
        
        echo "=== Step 2: Compile toolchain ==="
        make toolchain/compile V=s -j2 || make toolchain/compile V=s -j1
        
        echo "=== Step 3: Compile Lua ==="
        make package/utils/lua/host/compile V=s -j1
        make package/utils/lua/compile V=s -j1
        
        echo "=== Step 4: Compile Passwall2 ==="
        make package/luci-app-passwall2/{clean,compile} V=s -j2

    - name: Verify and collect build artifacts
      run: |
        cd openwrt
        echo "=== Build output structure ==="
        find bin -name "*.ipk" -type f | head -20
        
        echo "=== Passwall2 IPK files ==="
        find bin -name "*passwall*" -type f | head -10
        
        if ! find bin -name "*passwall*.ipk" -type f | grep -q .; then
          echo "ERROR: No Passwall2 IPK files found!"
          echo "Available IPK files:"
          find bin -name "*.ipk" -type f | head -20
          exit 1
        fi

    - name: Upload ipk artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Passwall2_IPK_$(date +%Y%m%d_%H%M%S)
        path: |
          openwrt/bin/packages/*/*/*passwall*
          openwrt/bin/targets/*/*/packages/*passwall*
        retention-days: 7
        if-no-files-found: error

    - name: Upload build logs for debugging
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: Build_Logs_$(date +%Y%m%d_%H%M%S)
        path: |
          openwrt/defconfig.log
          openwrt/logs/
          openwrt/build_dir/**/log*
        retention-days: 3
