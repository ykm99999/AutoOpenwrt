name: Build Passwall2 Package for SL-3000

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git wget unzip \
            libncurses5-dev libncursesw5-dev zlib1g-dev gawk \
            flex gettext libssl-dev xsltproc rsync libdeflate-dev libdeflate-tools

      - name: Clone OpenWrt SDK (aarch64_cortex-a53)
        run: |
          wget https://downloads.openwrt.org/releases/21.02.3/targets/armvirt/64/openwrt-sdk-21.02.3-armvirt-64_gcc-8.4.0_musl.Linux-x86_64.tar.xz
          tar -xf openwrt-sdk-21.02.3-armvirt-64_gcc-8.4.0_musl.Linux-x86_64.tar.xz
          mv openwrt-sdk-21.02.3-armvirt-64_gcc-8.4.0_musl.Linux-x86_64 openwrt-sdk
          cd openwrt-sdk
          echo "src-git passwall https://github.com/xiaorouji/openwrt-passwall2.git" >> feeds.conf.default

      - name: Update & install feeds
        working-directory: openwrt-sdk
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Compile Passwall2 package
        working-directory: openwrt-sdk
        run: |
          make package/luci-app-passwall2/compile V=s
          make package/luci-app-passwall2/install V=s

      - name: Upload Passwall2 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: passwall2-sl3000
          path: openwrt-sdk/bin/packages/aarch64_cortex-a53/*/luci-app-passwall2*.ipk
