name: å¸æ´›SL-3000 ImmortalWrt ç¨³å®šç¼–è¯‘

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x
  REPO_BRANCH: main
  CONFIG_FILE: sl3000.config
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
    - name: æ£€æŸ¥å·¥ä½œç©ºé—´
      run: |
        echo "=== åˆå§‹èµ„æºçŠ¶æ€ ==="
        df -h
        free -h

    - name: Checkout ä»£ç 
      uses: actions/checkout@v4

    - name: å®‰è£…å®Œæ•´ç¼–è¯‘ä¾èµ–
      run: |
        echo "=== å®‰è£…å®Œæ•´ç¼–è¯‘ä¾èµ– ==="
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ccache \
          cmake \
          git \
          make \
          libssl-dev \
          libncurses5-dev \
          zlib1g-dev \
          gawk \
          gettext \
          flex \
          bison \
          python3 \
          python3-pip \
          rsync \
          unzip \
          wget \
          curl \
          file \
          gzip \
          bzip2 \
          xz-utils \
          pkg-config \
          libtool \
          automake \
          autoconf \
          gettext \
          libelf-dev \
          libfuse-dev \
          libgmp3-dev \
          libmpc-dev \
          libmpfr-dev \
          libltdl-dev

    - name: æ·±åº¦ç£ç›˜æ¸…ç†
      run: |
        echo "=== æ·±åº¦ç£ç›˜æ¸…ç† ==="
        sudo apt-get autoremove -y
        sudo apt-get clean
        sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android /opt/hostedtoolcache 2>/dev/null || true
        sudo rm -rf /var/lib/apt/lists/* /tmp/* 2>/dev/null || true
        echo "æ¸…ç†åç£ç›˜ç©ºé—´:"
        df -h

    - name: é…ç½®æ™ºèƒ½ç¼“å­˜
      uses: actions/cache@v3
      with:
        path: |
          ~/.ccache
          ./openwrt/dl
          ./openwrt/build_dir
        key: ${{ runner.os }}-sl3000-stable-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-sl3000-stable-

    - name: å…‹éš†ç¨³å®šç‰ˆæºç 
      run: |
        echo "=== å…‹éš† ImmortalWrt MT798x ä¸»åˆ†æ”¯ ==="
        
        if [ -d "openwrt" ] && [ -d "openwrt/.git" ]; then
          echo "ä½¿ç”¨ç°æœ‰ä»“åº“å¹¶æ›´æ–°"
          cd openwrt
          git fetch --depth=1 origin main
          git reset --hard origin/main
        else
          echo "å…‹éš†æ–°ä»“åº“"
          rm -rf openwrt
          git clone --depth=1 --branch $REPO_BRANCH $REPO_URL openwrt
        fi

    - name: ä¿®å¤å·¥å…·é“¾é—®é¢˜
      run: |
        cd openwrt
        
        echo "=== ä¿®å¤å·¥å…·é“¾å’Œä¾èµ–é—®é¢˜ ==="
        
        # ç¡®ä¿ feeds é…ç½®æ­£ç¡®
        cat > feeds.conf.default << 'EOF'
src-git packages https://git.openwrt.org/feed/packages.git
src-git luci https://git.openwrt.org/project/luci.git
src-git routing https://git.openwrt.org/feed/routing.git
src-git telephony https://git.openwrt.org/feed/telephony.git
EOF

        # æ›´æ–° feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: åº”ç”¨è®¾å¤‡é…ç½®
      run: |
        cd openwrt
        
        echo "=== åº”ç”¨è®¾å¤‡é…ç½® ==="
        
        if [ -f "../$CONFIG_FILE" ]; then
          echo "ä½¿ç”¨è‡ªå®šä¹‰é…ç½®æ–‡ä»¶"
          cp "../$CONFIG_FILE" .config
        else
          echo "ä½¿ç”¨ç²¾ç®€é…ç½®é¿å…ä¾èµ–é—®é¢˜"
          cat > .config << 'EOF'
CONFIG_TARGET_mediatek=y
CONFIG_TARGET_mediatek_mt7981=y
CONFIG_TARGET_mediatek_mt7981_DEVICE_cmcc_rax3000m-nand-ubootmod=y

# åŸºç¡€ç³»ç»Ÿ
CONFIG_TARGET_ROOTFS_PARTSIZE=512

# æ ¸å¿ƒåŒ… - é¿å…å¤æ‚ä¾èµ–
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-base=y
CONFIG_PACKAGE_luci-compat=y
CONFIG_PACKAGE_luci-theme-bootstrap=y
CONFIG_PACKAGE_luci-i18n-base-zh-cn=y

# ç½‘ç»œåŸºç¡€
CONFIG_PACKAGE_wpad-basic-wolfssl=y
CONFIG_PACKAGE_kmod-mt7981-firmware=y

# åŸºç¡€å·¥å…·
CONFIG_PACKAGE_block-mount=y
CONFIG_PACKAGE_fdisk=y

# ç®€åŒ–é…ç½®ï¼Œé¿å…é—®é¢˜åŒ…
# CONFIG_PACKAGE_luci-app-passwall2 is not set
# CONFIG_PACKAGE_docker is not set
EOF
        fi
        
        make defconfig

    - name: é¢„ä¸‹è½½å·¥å…·é“¾
      run: |
        cd openwrt
        
        echo "=== é¢„ä¸‹è½½å·¥å…·é“¾å’Œæ ¸å¿ƒåŒ… ==="
        
        # å…ˆä¸‹è½½å·¥å…·é“¾ç›¸å…³åŒ…
        make toolchain/download -j2
        make toolchain/install -j2
        
        # ä¸‹è½½æ ¸å¿ƒåŒ…
        make package/lua/host/download -j2
        make package/luci-base/host/download -j2

    - name: ä¸‹è½½æ‰€æœ‰è½¯ä»¶åŒ…
      run: |
        cd openwrt
        
        echo "=== ä¸‹è½½æ‰€æœ‰è½¯ä»¶åŒ… ==="
        make download -j2
        
        # æ£€æŸ¥ä¸‹è½½å®Œæ•´æ€§
        echo "ä¸‹è½½æ–‡ä»¶æ£€æŸ¥:"
        find dl -name "*.gz" -o -name "*.xz" -o -name "*.bz2" | head -10
        echo "dlç›®å½•å¤§å°:"
        du -sh dl/

    - name: åˆ†é˜¶æ®µç¼–è¯‘
      id: compile
      run: |
        cd openwrt
        
        echo "=== åˆ†é˜¶æ®µç¼–è¯‘ ==="
        echo "ç¼–è¯‘å‰èµ„æºçŠ¶æ€:"
        free -h
        df -h
        
        # åˆ†é˜¶æ®µç¼–è¯‘ï¼Œç¡®ä¿å·¥å…·é“¾å…ˆå®Œæˆ
        echo "é˜¶æ®µ1: ç¼–è¯‘å·¥å…·é“¾..."
        make toolchain/compile -j2
        
        echo "é˜¶æ®µ2: ç¼–è¯‘ç›®æ ‡å·¥å…·..."
        make target/compile -j2
        
        echo "é˜¶æ®µ3: ç¼–è¯‘è½¯ä»¶åŒ…..."
        make package/compile -j2 || make package/compile -j1 V=s
        
        echo "é˜¶æ®µ4: æœ€ç»ˆé“¾æ¥..."
        make package/install -j2
        
        echo "é˜¶æ®µ5: ç”Ÿæˆé•œåƒ..."
        make target/install -j2
        
        echo "status=success" >> $GITHUB_OUTPUT
        echo "DEVICE_NAME=sl3000" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      if: steps.compile.outputs.status == 'success' && !cancelled()
      run: |
        cd openwrt/bin/targets/*/*
        echo "=== å›ºä»¶æ–‡ä»¶ ==="
        ls -la
        rm -rf packages 2>/dev/null || true
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV

    - name: ä¸Šä¼ å›ºä»¶åˆ¶å“
      if: steps.compile.outputs.status == 'success' && !cancelled()
      uses: actions/upload-artifact@v4
      with:
        name: ImmortalWrt_SL3000_å›ºä»¶_${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}/*
        retention-days: 30

    - name: å‘å¸ƒåˆ° GitHub Release
      if: env.UPLOAD_RELEASE == 'true' && steps.compile.outputs.status == 'success' && !cancelled()
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: ${{ env.FIRMWARE }}/*
        tag_name: sl3000-build-${{ env.FILE_DATE }}
        name: å¸æ´› SL-3000 å›ºä»¶ ${{ env.FILE_DATE }}
        body: |
          # å¸æ´› SL-3000 ImmortalWrt å›ºä»¶
          ğŸš€ ç¨³å®šç‰ˆç¼–è¯‘å®Œæˆ
        draft: false
        prerelease: false

    - name: ç¼–è¯‘çŠ¶æ€é€šçŸ¥
      if: always()
      run: |
        if [ "${{ steps.compile.outputs.status }}" = "success" ]; then
          echo "ğŸ‰ å›ºä»¶ç¼–è¯‘æˆåŠŸ!"
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥"
        fi
