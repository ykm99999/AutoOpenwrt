name: Build Passwall2 (Fixed Lua Host)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 150  # 稍微增加超时时间

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install deps
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential ccache cmake git make libssl-dev \
          libncurses5-dev zlib1g-dev gawk gettext flex bison \
          python3 python3-pip rsync unzip wget pkg-config libtool autoconf automake \
          libreadline-dev curl
        # 安装可能缺失的依赖
        sudo apt-get install -y libjson-c-dev libuv1-dev

    - name: Clone and init feeds (with retry)
      run: |
        # 添加重试机制
        for i in {1..3}; do
          git clone https://github.com/padavanonly/immortalwrt-mt798x.git openwrt && break || sleep 10
        done
        cd openwrt
        # 指定分支避免主分支不稳定
        git checkout main || git checkout master
        
        # 更新feeds带重试
        for i in {1..3}; do
          ./scripts/feeds update -a && break || sleep 10
        done
        ./scripts/feeds install -a
        make defconfig

    - name: Setup build environment
      run: |
        cd openwrt
        # 设置并行编译数，根据runner配置调整
        echo "CONFIG_CCACHE=y" >> .config
        echo "BUILD_SUFFIX=github" >> .config
        
        # 确保必要的配置
        make defconfig

    - name: Build libdeflate with robust fallback
      run: |
        cd openwrt
        # 先尝试正常构建libdeflate
        if ! make tools/libdeflate/{clean,compile,install} V=s -j2; then
          echo "libdeflate build failed, using system gzip fallback"
          mkdir -p staging_dir/host/bin
          # 创建更健壮的fallback脚本
          cat > staging_dir/host/bin/libdeflate-gzip <<'EOF'
#!/usr/bin/env bash
# Fallback to system gzip with proper error handling
if command -v gzip >/dev/null 2>&1; then
  exec gzip "$@"
else
  echo "Error: gzip not found in system" >&2
  exit 1
fi
EOF
          chmod +x staging_dir/host/bin/libdeflate-gzip
        fi
        # 验证fallback是否可用
        test -x staging_dir/host/bin/libdeflate-gzip || exit 1
        echo "libdeflate-gzip setup completed"

    - name: Ensure Lua source integrity
      run: |
        cd openwrt
        # 彻底清理可能损坏的Lua源
        rm -rf dl/lua-*.tar.gz build_dir/target-*/lua-* build_dir/host/lua-*
        
        # 分步下载和验证
        make package/utils/lua/clean V=s
        if ! make package/utils/lua/download V=s; then
          echo "Lua download failed, manual download attempt"
          # 手动下载Lua源码作为备选方案
          wget -O dl/lua-5.1.5.tar.gz http://www.lua.org/ftp/lua-5.1.5.tar.gz || \
          wget -O dl/lua-5.1.5.tar.gz https://github.com/lua/lua/archive/refs/tags/v5.1.5.tar.gz
        fi
        
        # 严格验证下载的文件
        find dl -name "lua-*.tar.gz" -exec gzip -t {} \; || exit 1
        # 检查文件大小，太小的文件可能是下载失败
        find dl -name "lua-*.tar.gz" -size -10k -delete

    - name: Step-by-step compilation
      run: |
        cd openwrt
        set -e  # 任何步骤失败立即退出
        
        echo "=== Step 1: Compile tools ==="
        make tools/compile V=s -j2 || make tools/compile V=s -j1
        
        echo "=== Step 2: Compile toolchain ==="
        make toolchain/compile V=s -j2 || make toolchain/compile V=s -j1
        
        echo "=== Step 3: Compile Lua ==="
        # 先确保依赖已构建
        make package/utils/lua/host/compile V=s -j1
        make package/utils/lua/compile V=s -j1
        
        echo "=== Step 4: Compile Passwall2 dependencies ==="
        # 先编译Passwall2的依赖
        make package/luci-app-passwall2/host/compile V=s -j1
        
        echo "=== Step 5: Final Passwall2 compilation ==="
        make package/luci-app-passwall2/compile V=s -j2

    - name: Verify and collect build artifacts
      run: |
        cd openwrt
        echo "=== Build output structure ==="
        find bin -name "*.ipk" -type f | head -20
        
        echo "=== Passwall2 IPK files ==="
        find bin -name "*passwall*" -type f | head -10
        
        # 检查是否生成了目标文件
        if ! find bin -name "*passwall*.ipk" -type f | grep -q .; then
          echo "ERROR: No Passwall2 IPK files found!"
          echo "Available IPK files:"
          find bin -name "*.ipk" -type f | head -20
          exit 1
        fi

    - name: Upload ipk artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Passwall2_IPK_$(date +%Y%m%d_%H%M%S)
        path: |
          openwrt/bin/packages/*/*/*passwall*
          openwrt/bin/targets/*/*/packages/*passwall*
        retention-days: 7
        if-no-files-found: error  # 如果没有文件则失败

    - name: Upload build logs for debugging
      if: failure()  # 仅在失败时上传日志
      uses: actions/upload-artifact@v4
      with:
        name: Build_Logs_$(date +%Y%m%d_%H%M%S)
        path: |
          openwrt/logs/
          openwrt/build_dir/**/log*
        retention-days: 3
