name: Build Custom Packages

on:
  workflow_dispatch:
    inputs:
      package_list:
        description: '要编译的软件包列表（逗号分隔）'
        required: false
        default: 'docker,dockerd,luci-app-passwall2'
        type: string

env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x

jobs:
  build-packages:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libssl-dev libncurses5-dev gawk gettext

    - name: Clone Source
      run: |
        git clone --depth=1 $REPO_URL openwrt

    - name: Setup Environment
      run: |
        cd openwrt
        # 修复 feeds 问题
        sed -i 's|src-git modemfeed|# src-git modemfeed|' feeds.conf.default
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Build Toolchain Only
      run: |
        cd openwrt
        # 最小化配置
        echo "CONFIG_TARGET_mediatek_mt7981=y" > .config
        make defconfig
        # 只编译工具链
        make toolchain/compile -j2

    - name: Build Requested Packages
      run: |
        cd openwrt
        
        # 解析包列表
        IFS=',' read -ra PACKAGES <<< "${{ github.event.inputs.package_list }}"
        
        echo "开始编译以下包: ${PACKAGES[@]}"
        
        for pkg in "${PACKAGES[@]}"; do
          echo "编译包: $pkg"
          make package/$pkg/compile -j2 || echo "编译 $pkg 失败，继续..."
        done

    - name: Collect and Upload
      run: |
        cd openwrt
        
        # 收集所有包
        mkdir -p ../output-packages
        find bin/packages -name "*.ipk" -exec cp {} ../output-packages/ \;
        
        echo "编译完成的包:"
        ls -la ../output-packages/
        echo "PACKAGES_DIR=$(pwd)/../output-packages" >> $GITHUB_ENV

    - name: Upload Packages Artifact
      uses: actions/upload-artifact@v4
      with:
        name: custom-packages
        path: ${{ env.PACKAGES_DIR }}/*
        retention-days: 30

    - name: Create Packages Release
      uses: softprops/action-gh-release@v2
      if: success()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: ${{ env.PACKAGES_DIR }}/*
        tag_name: packages-$(date +%Y%m%d-%H%M)
        name: Custom Packages $(date +%Y-%m-%d)
        body: |
          # 自定义编译的 OpenWrt 软件包
          
          编译时间: $(date)
          包含的包: ${{ github.event.inputs.package_list }}
          
          这些包针对以下平台编译:
          - 架构: aarch64_cortex-a53
          - 目标: Mediatek MT7981
          - 设备: 司洛 SL-3000
        draft: false
        prerelease: false
