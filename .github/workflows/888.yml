- name: Download snapshot SDK
        run: |
          set -e
          TARGET="ramips/mt7621"
          BASE="https://downloads.openwrt.org/snapshots/targets/${TARGET}/"

          # 尝试从目录索引解析 SDK 文件名
          SDK_FILE="$(curl -fsSL ${BASE} | grep -oE 'openwrt-sdk-[^"]*Linux-x86_64\.tar\.xz' | head -n1 || true)"
          echo "Parsed from index: SDK_FILE='${SDK_FILE}'"

          # 如果失败，尝试从 sha256sums 解析
          if [ -z "${SDK_FILE}" ]; then
            echo "Index parse failed, try sha256sums..."
            SDK_FILE="$(curl -fsSL ${BASE}sha256sums | grep -oE 'openwrt-sdk-[^ ]*Linux-x86_64\.tar\.xz' | head -n1 || true)"
            echo "Parsed from sha256sums: SDK_FILE='${SDK_FILE}'"
          fi

          # 仍失败则明确报错退出
          if [ -z "${SDK_FILE}" ]; then
            echo "ERROR: No SDK tarball found under ${BASE}"
            echo "Possible causes:"
            echo "  - Snapshot for target '${TARGET}' has not published SDK today."
            echo "  - Directory layout changed or index not listing SDK."
            exit 1
          fi

          echo "Downloading: ${BASE}${SDK_FILE}"
          wget -q ${BASE}${SDK_FILE} -O sdk.tar.xz
          mkdir -p sdk
          tar -xf sdk.tar.xz -C sdk --strip-components=1
          echo "SDK unpacked to ./sdk"
