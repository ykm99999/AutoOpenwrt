name: å¸æ´›SL-3000 è½¯ä»¶åŒ…ç¼–è¯‘ (Docker + PassWall2)

on:
  workflow_dispatch:
    inputs:
      clean_build:
        description: 'æ¸…ç†ç¼–è¯‘'
        required: false
        default: false
        type: boolean
  push:
    branches: [ main, master ]
  schedule:
    - cron: '0 2 * * 0'

env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-24.10
  REPO_BRANCH: 2410
  TZ: Asia/Shanghai

jobs:
  build-packages:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
    - name: æ£€æŸ¥å·¥ä½œç©ºé—´
      run: |
        echo "=== åˆå§‹èµ„æºçŠ¶æ€ ==="
        df -h
        free -h

    - name: Checkout ä»£ç 
      uses: actions/checkout@v4

    - name: æ·±åº¦ç£ç›˜æ¸…ç†
      run: |
        echo "=== æ·±åº¦ç£ç›˜æ¸…ç† ==="
        sudo apt-get autoremove -y
        sudo apt-get clean
        sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android /opt/hostedtoolcache 2>/dev/null || true
        sudo rm -rf /var/lib/apt/lists/* /tmp/* 2>/dev/null || true
        echo "æ¸…ç†åç£ç›˜ç©ºé—´:"
        df -h

    - name: é…ç½®æ™ºèƒ½ç¼“å­˜
      uses: actions/cache@v3
      with:
        path: |
          ~/.ccache
          ./openwrt/dl
          ./openwrt/build_dir
          ./openwrt/staging_dir
        key: ${{ runner.os }}-sl3000-pkgs-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-sl3000-pkgs-

    - name: å…‹éš† ImmortalWrt æºç 
      run: |
        echo "=== å…‹éš†æºç  ==="
        if [ -d "openwrt" ] && [ -d "openwrt/.git" ]; then
          echo "ä½¿ç”¨ç°æœ‰ä»“åº“"
          cd openwrt
          git fetch --depth=1
          git reset --hard origin/$REPO_BRANCH
        else
          echo "å…‹éš†æ–°ä»“åº“"
          rm -rf openwrt
          git clone --depth=1 --branch $REPO_BRANCH $REPO_URL openwrt
        fi

    - name: å®‰è£…æœ€å°åŒ–ä¾èµ–
      run: |
        echo "=== å®‰è£…ç¼–è¯‘ä¾èµ– ==="
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ccache \
          git \
          make \
          libssl-dev \
          libncurses5-dev \
          zlib1g-dev \
          gawk \
          gettext \
          flex \
          bison \
          python3 \
          rsync \
          unzip \
          wget

    - name: é…ç½®åŸºç¡€ç¯å¢ƒ
      run: |
        cd openwrt
        
        echo "=== é…ç½®åŸºç¡€ç¯å¢ƒ ==="
        # æœ€å°åŒ–feedsé…ç½®
        cat > feeds.conf.default << 'EOF'
        src-git packages https://git.openwrt.org/feed/packages.git;openwrt-24.10
        src-git luci https://git.openwrt.org/project/luci.git;openwrt-24.10
        src-git routing https://git.openwrt.org/feed/routing.git;openwrt-24.10
        EOF
        
        # æ›´æ–°åŸºç¡€feeds
        ./scripts/feeds update -a
        
        # å®‰è£…åŸºç¡€åŒ…
        ./scripts/feeds install -a

    - name: æ·»åŠ  Docker å’Œ PassWall2 æº
      run: |
        cd openwrt
        
        echo "=== æ·»åŠ é¢å¤–è½¯ä»¶æº ==="
        # æ·»åŠ  Docker ç›¸å…³æº
        if ! grep -q "docker" feeds.conf.default; then
          cat >> feeds.conf.default << 'EOF'
        
        # Docker ç›¸å…³
        src-git dockerd https://github.com/openwrt/packages.git;openwrt-24.10
        EOF
        fi
        
        # æ·»åŠ  PassWall2 æº
        if ! grep -q "passwall" feeds.conf.default; then
          cat >> feeds.conf.default << 'EOF'
        
        # PassWall2
        src-git passwall2 https://github.com/xiaorouji/openwrt-passwall2;main
        EOF
        fi
        
        # æ›´æ–°æ‰€æœ‰feeds
        ./scripts/feeds update -a

    - name: å®‰è£… Docker ç›¸å…³åŒ…
      run: |
        cd openwrt
        
        echo "=== å®‰è£… Docker åŒ… ==="
        # å®‰è£… Docker æ ¸å¿ƒåŒ…
        ./scripts/feeds install -p dockerd dockerd
        ./scripts/feeds install -p dockerd docker
        ./scripts/feeds install -p dockerd docker-compose
        ./scripts/feeds install -p dockerd containerd
        ./scripts/feeds install -p dockerd runc
        
        # å®‰è£…ä¾èµ–åŒ…
        ./scripts/feeds install -p packages libnetwork
        ./scripts/feeds install -p packages tini

    - name: å®‰è£… PassWall2 åŒ…
      run: |
        cd openwrt
        
        echo "=== å®‰è£… PassWall2 åŒ… ==="
        # å®‰è£… PassWall2 æ ¸å¿ƒåŒ…
        ./scripts/feeds install -p passwall2 luci-app-passwall2
        ./scripts/feeds install -p passwall2 luci-i18n-passwall2-zh-cn
        
        # å®‰è£…ä¾èµ–
        ./scripts/feeds install -p packages luci-compat
        ./scripts/feeds install -p packages luci-lib-ipkg

    - name: åˆ›å»ºæœ€å°åŒ–é…ç½®
      run: |
        cd openwrt
        
        echo "=== åˆ›å»ºè½¯ä»¶åŒ…ç¼–è¯‘é…ç½® ==="
        # åˆ›å»ºé’ˆå¯¹ SL-3000 (mt7981) çš„é…ç½®
        cat > .config << 'EOF'
        CONFIG_TARGET_mediatek_mt7981=y
        CONFIG_TARGET_mediatek_mt7981_DEVICE_cmcc_rax3000m-nand-ubootmod=y
        
        # æ¶æ„é…ç½®
        CONFIG_TARGET_mediatek=y
        CONFIG_TARGET_mediatek_mt7981=y
        CONFIG_TARGET_SUBTARGET="mt7981"
        CONFIG_TARGET_ARCH_PACKAGES="aarch64_cortex-a53"
        
        # åŸºç¡€é…ç½®
        CONFIG_BUILD_PATENTED=y
        CONFIG_BUILD_NOSANITIZE=y
        
        # Docker é…ç½®
        CONFIG_PACKAGE_dockerd=y
        CONFIG_PACKAGE_docker=y
        CONFIG_PACKAGE_docker-compose=y
        CONFIG_PACKAGE_containerd=y
        CONFIG_PACKAGE_runc=y
        CONFIG_PACKAGE_libnetwork=y
        CONFIG_PACKAGE_tini=y
        
        # PassWall2 é…ç½®
        CONFIG_PACKAGE_luci-app-passwall2=y
        CONFIG_PACKAGE_luci-i18n-passwall2-zh-cn=y
        CONFIG_PACKAGE_luci-compat=y
        CONFIG_PACKAGE_luci-lib-ipkg=y
        
        # ç½‘ç»œå·¥å…·ä¾èµ–
        CONFIG_PACKAGE_iptables-mod-extra=y
        CONFIG_PACKAGE_kmod-ipt-offload=y
        EOF
        
        # ç”Ÿæˆå®Œæ•´é…ç½®
        make defconfig

    - name: ä¸‹è½½ä¾èµ–åŒ…
      run: |
        cd openwrt
        
        echo "=== ä¸‹è½½è½¯ä»¶åŒ… ==="
        make download -j2
        
        # æ£€æŸ¥ä¸‹è½½ç»“æœ
        echo "ä¸‹è½½çš„åŒ…æ•°é‡:"
        ls dl/*.zip dl/*.tar.gz dl/*.bz2 2>/dev/null | wc -l || echo "0"

    - name: ç¼–è¯‘ Docker è½¯ä»¶åŒ…
      run: |
        cd openwrt
        
        echo "=== ç¼–è¯‘ Docker åŒ… ==="
        echo "ç£ç›˜ç©ºé—´:"
        df -h
        
        # å•ç‹¬ç¼–è¯‘ Docker ç›¸å…³åŒ…
        for pkg in dockerd docker docker-compose containerd runc libnetwork tini; do
          echo "ç¼–è¯‘åŒ…: $pkg"
          make package/$pkg/compile -j2 V=s || echo "ç¼–è¯‘ $pkg å¤±è´¥ï¼Œç»§ç»­..."
        done

    - name: ç¼–è¯‘ PassWall2 è½¯ä»¶åŒ…
      run: |
        cd openwrt
        
        echo "=== ç¼–è¯‘ PassWall2 åŒ… ==="
        echo "ç£ç›˜ç©ºé—´:"
        df -h
        
        # ç¼–è¯‘ PassWall2
        make package/luci-app-passwall2/compile -j2 V=s
        make package/luci-i18n-passwall2-zh-cn/compile -j2 V=s

    - name: æ”¶é›†ç¼–è¯‘çš„è½¯ä»¶åŒ…
      run: |
        cd openwrt
        
        echo "=== æ”¶é›†è½¯ä»¶åŒ… ==="
        
        # åˆ›å»ºè¾“å‡ºç›®å½•
        mkdir -p ../packages-output
        
        # å¤åˆ¶ Docker ç›¸å…³åŒ…
        find bin/packages -name "dockerd*.ipk" -exec cp {} ../packages-output/ \;
        find bin/packages -name "docker*.ipk" -exec cp {} ../packages-output/ \;
        find bin/packages -name "containerd*.ipk" -exec cp {} ../packages-output/ \;
        find bin/packages -name "runc*.ipk" -exec cp {} ../packages-output/ \;
        find bin/packages -name "libnetwork*.ipk" -exec cp {} ../packages-output/ \;
        find bin/packages -name "tini*.ipk" -exec cp {} ../packages-output/ \;
        
        # å¤åˆ¶ PassWall2 åŒ…
        find bin/packages -name "luci-app-passwall2*.ipk" -exec cp {} ../packages-output/ \;
        find bin/packages -name "luci-i18n-passwall2*.ipk" -exec cp {} ../packages-output/ \;
        find bin/packages -name "luci-compat*.ipk" -exec cp {} ../packages-output/ \;
        find bin/packages -name "luci-lib-ipkg*.ipk" -exec cp {} ../packages-output/ \;
        
        echo "ç¼–è¯‘å®Œæˆçš„åŒ…:"
        ls -la ../packages-output/
        echo "PACKAGES_DIR=$GITHUB_WORKSPACE/packages-output" >> $GITHUB_ENV

    - name: ä¸Šä¼ è½¯ä»¶åŒ…åˆ¶å“
      uses: actions/upload-artifact@v4
      with:
        name: SL3000-è½¯ä»¶åŒ…-Docker-PassWall2
        path: ${{ env.PACKAGES_DIR }}/*
        retention-days: 30
        compression-level: 0

    - name: å‘å¸ƒåˆ° Release
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: ${{ env.PACKAGES_DIR }}/*
        tag_name: packages-$(date +%Y%m%d-%H%M)
        name: SL3000 è½¯ä»¶åŒ… $(date +%Y-%m-%d)
        body: |
          # å¸æ´› SL-3000 è½¯ä»¶åŒ…
          
          ## åŒ…å«å†…å®¹
          - ğŸ³ Docker å…¨å®¶æ¡¶
          - ğŸ”’ PassWall2 ç§‘å­¦ä¸Šç½‘
          - ğŸŒ ä¸­æ–‡è¯­è¨€åŒ…
          
          ## æ¶æ„ä¿¡æ¯
          - **å¹³å°**: Mediatek MT7981 (aarch64_cortex-a53)
          - **ç³»ç»Ÿ**: ImmortalWrt 24.10
          - **ç¼–è¯‘æ—¶é—´**: $(date)
          
          ## å®‰è£…è¯´æ˜
          1. ä¸Šä¼ åˆ°è·¯ç”±å™¨çš„ /tmp ç›®å½•
          2. è¿è¡Œ: `opkg install /tmp/*.ipk`
          3. æˆ–é€šè¿‡ LuCI è½¯ä»¶åŒ…é¡µé¢å®‰è£…
        draft: false
        prerelease: false

    - name: æ¸…ç†å·¥ä½œç©ºé—´
      if: always()
      run: |
        echo "=== æœ€ç»ˆæ¸…ç† ==="
        # ä¿ç•™ dl ç›®å½•ä¾›ä¸‹æ¬¡ä½¿ç”¨ï¼Œæ¸…ç†å…¶ä»–
        rm -rf openwrt/build_dir openwrt/staging_dir openwrt/tmp
        echo "æœ€ç»ˆç£ç›˜ç©ºé—´:"
        df -h
